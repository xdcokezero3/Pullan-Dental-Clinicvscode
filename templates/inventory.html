<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pullan Dental Clinic - Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inventory.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        /* Additional CSS for better functionality */
        .alert {
            padding: 15px;
            margin: 20px 0;
            border: 1px solid transparent;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        
        .loading-spinner i {
            font-size: 2em;
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .item-details {
            display: grid;
            gap: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .status-badge.ok {
            background-color: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .status-badge.low {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .status-badge.expired {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .status-badge.expired-low {
            background-color: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .btn-loading {
            display: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            color: #dee2e6;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        /* Status filtering styles */
        .status-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-filter-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            text-decoration: none;
            color: #495057;
            font-size: 14px;
            transition: all 0.2s;
            position: relative;
        }
        
        .status-filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .status-filter-btn:hover {
            background: #e9ecef;
            text-decoration: none;
        }
        
        .status-filter-btn.active:hover {
            background: #0056b3;
        }
        
        .filter-badge {
            background: #6c757d;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .status-filter-btn.active .filter-badge {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Inactive item styling */
        .inventory-table tr.inactive {
            opacity: 0.6;
            background-color: #f8f9fa;
        }
        
        .inventory-table tr.inactive td {
            color: #6c757d;
        }
        
        .status-badge.inactive {
            background-color: #6c757d;
            color: white;
        }
        
        .reactivate-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .reactivate-btn:hover {
            background: #218838;
        }
        
        .deactivate-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .deactivate-btn:hover {
            background: #c82333;
        }

        /* Form validation styles */
        .form-group.error input {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-group.success input {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .success-message {
            color: #28a745;
            font-size: 0.875em;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand">
                <h2>Pullan Dental</h2>
                <p>Clinic Management System</p>
            </div>
            <ul class="nav-menu">
                <!-- Admin Only - Backup & Restore -->
                {% if session.get('access_level') == 'admin' %}
                <li><a href="{{ url_for('backup_restore') }}"><i class="fas fa-database"></i> Backup & Restore</a></li>
                {% endif %}
                <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="{{ url_for('patients') }}"><i class="fas fa-user-injured"></i> Patients</a></li>
                <li><a href="{{ url_for('appointments') }}"><i class="fas fa-calendar-alt"></i> Appointments</a></li>
                <li><a href="{{ url_for('staff') }}"><i class="fas fa-user-md"></i> Staff</a></li>
                <li class="active"><a href="{{ url_for('inventory') }}"><i class="fas fa-box"></i> Inventory</a></li>
                <li><a href="{{ url_for('dental_charts') }}"><i class="fas fa-teeth"></i> Dental Charts</a></li>
                <!-- Admin Only - User Logs -->
                {% if session.get('access_level') == 'admin' %}
                <li><a href="{{ url_for('user_logs') }}"><i class="fas fa-history"></i> User Logs</a></li>
                {% endif %}
                <!-- ADD THIS LINE FOR FAQ BUTTON -->
                <li><a href="{{ url_for('faq') }}"><i class="fas fa-question-circle"></i> FAQ</a></li>
                <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> About</a></li>
            </ul>
            <div class="logout">
                <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-bar">
                    <input type="text" id="inventorySearch" placeholder="Search inventory...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="user-info">
                    <div class="user">
                        <span>{{ session.get('real_name', session.get('username', 'User')) }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Page Content -->
            <div class="inventory-container">
                <div class="page-header">
                    <h1>Inventory Management</h1>
                    <p class="date">{{ current_date }}</p>
                    <div class="header-actions">
                        <button id="printInventoryBtn" class="secondary-btn"><i class="fas fa-print"></i> Print Report</button>
                        <button id="addItemBtn" class="primary-btn"><i class="fas fa-plus"></i> Add New Item</button>
                    </div>
                </div>
                
                <!-- Success/Error Messages -->
                {% if error %}
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ error }}
                </div>
                {% endif %}
                
                {% if success %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    {{ success }}
                </div>
                {% endif %}
                
                <!-- Status Filters -->
                <div class="status-filters">
                    <a href="{{ url_for('inventory', status='active') }}" 
                       class="status-filter-btn {% if status_filter == 'active' %}active{% endif %}">
                        <i class="fas fa-check-circle"></i> Active Items
                        <span class="filter-badge">{{ active_count or 0 }}</span>
                    </a>
                    <a href="{{ url_for('inventory', status='inactive') }}" 
                       class="status-filter-btn {% if status_filter == 'inactive' %}active{% endif %}">
                        <i class="fas fa-times-circle"></i> Inactive Items
                        <span class="filter-badge">{{ inactive_count or 0 }}</span>
                    </a>
                    <a href="{{ url_for('inventory', status='all') }}" 
                       class="status-filter-btn {% if status_filter == 'all' %}active{% endif %}">
                        <i class="fas fa-list"></i> All Items
                        <span class="filter-badge">{{ total_count or 0 }}</span>
                    </a>
                </div>
                
                <!-- Inventory Stats (Only show for active items) -->
                {% if status_filter == 'active' or status_filter == 'all' %}
                <div class="stats-cards">
                    <div class="card total-items">
                        <div class="card-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="card-info">
                            <h3 id="totalItemsCount">{{ total_items or 0 }}</h3>
                            <p>Active Items</p>
                        </div>
                    </div>
                    
                    <div class="card low-stock">
                        <div class="card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="card-info">
                            <h3 id="lowStockCount">{{ low_stock_count or 0 }}</h3>
                            <p>Low Stock Items</p>
                        </div>
                    </div>
                    
                    <div class="card expired">
                        <div class="card-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="card-info">
                            <h3 id="expiredCount">{{ expired_count or 0 }}</h3>
                            <p>Expired Items</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
               
                <div class="inventory-filters">
                    <button class="filter-btn active" data-filter="all">All Categories</button>
                    <button class="filter-btn" data-filter="consumables">Consumables</button>
                    <button class="filter-btn" data-filter="equipment">Equipment</button>
                    <button class="filter-btn" data-filter="medicines">Medicines</button>
                    <button class="filter-btn" data-filter="instruments">Instruments</button>
                    <button class="filter-btn" data-filter="office_supplies">Office Supplies</button>
                    {% if status_filter == 'active' or status_filter == 'all' %}
                    <button class="filter-btn warning" data-filter="low_stock">Low Stock (<span id="lowStockFilterCount">0</span>)</button>
                    <button class="filter-btn danger" data-filter="expired">Expired (<span id="expiredFilterCount">0</span>)</button>
                    {% endif %}
                </div>
                
                <!-- Inventory Table -->
                <div class="inventory-table-container">
                    {% if inventory_items %}
                    <table id="inventoryTable" class="inventory-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Expiry Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory_items %}
                            <tr data-id="{{ item.raw_id }}" 
                                data-type="{{ item.type|lower|replace(' ', '_') if item.type else 'unknown' }}" 
                                data-name="{{ item.name|lower }}"
                                class="{% if not item.is_active %}inactive{% endif %}{% if item.status == 'Low Stock' or item.status == 'Low' %} low-stock{% endif %}{% if 'expired' in item.status|lower %} expired{% endif %}">
                                <td>{{ item.id }}</td>
                                <td>{{ item.name }}{% if not item.is_active %} <small class="text-muted">(Inactive)</small>{% endif %}</td>
                                <td>{{ item.type or 'N/A' }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.expiry if item.expiry != 'N/A' else 'No Expiry' }}</td>
                                <td>
                                    {% if not item.is_active %}
                                    <span class="status-badge inactive">Inactive</span>
                                    {% else %}
                                    <span class="status-badge {{ item.status|lower|replace(' ', '-') }}">{{ item.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="view-btn" title="View Details" data-id="{{ item.raw_id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if item.is_active %}
                                        <button class="edit-btn" title="Edit Item" data-id="{{ item.raw_id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="deactivate-btn" title="Deactivate Item" data-id="{{ item.raw_id }}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% else %}
                                        <button class="reactivate-btn" title="Reactivate Item" data-id="{{ item.raw_id }}">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        {% if status_filter == 'inactive' %}
                        <h3>No inactive inventory items</h3>
                        <p>All your inventory items are currently active.</p>
                        {% elif status_filter == 'active' %}
                        <h3>No active inventory items found</h3>
                        <p>Start by adding your first inventory item.</p>
                        <button id="addFirstItemBtn" class="primary-btn">
                            <i class="fas fa-plus"></i> Add First Item
                        </button>
                        {% else %}
                        <h3>No inventory items found</h3>
                        <p>Start by adding your first inventory item.</p>
                        <button id="addFirstItemBtn" class="primary-btn">
                            <i class="fas fa-plus"></i> Add First Item
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Item</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="inventoryForm">
                    <input type="hidden" id="itemId" name="itemId">
                    
                    <div class="form-group" id="itemNameGroup">
                        <label for="itemName">Item Name*</label>
                        <input type="text" id="itemName" name="name" required>
                        <div id="itemNameError" class="error-message" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span></span>
                        </div>
                        <div id="itemNameSuccess" class="success-message" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span>Item name is available</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemType">Category*</label>
                            <select id="itemType" name="type" required>
                                <option value="">Select Category</option>
                                <option value="Consumables">Consumables</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Medicines">Medicines</option>
                                <option value="Instruments">Instruments</option>
                                <option value="Office Supplies">Office Supplies</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="itemQuantity">Quantity*</label>
                            <input type="number" id="itemQuantity" name="quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemExpiry">Expiry Date</label>
                            <input type="date" id="itemExpiry" name="expiry_date">
                            <small>Leave blank for non-expiring items</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="minQuantity">Minimum Quantity</label>
                            <input type="number" id="minQuantity" name="min_quantity" min="0" value="5">
                            <small>For low stock alerts</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemRemarks">Remarks</label>
                        <textarea id="itemRemarks" name="remarks" rows="3" placeholder="Optional notes about this item..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="cancelBtn" class="secondary-btn">Cancel</button>
                        <button type="submit" id="saveItemBtn" class="primary-btn">
                            <span class="btn-text">Save Item</span>
                            <span class="btn-loading">
                                <i class="fas fa-spinner fa-spin"></i> Saving...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- View Item Details Modal -->
    <div id="viewItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Item Details</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="itemDetails">
                    <!-- Details will be populated by JavaScript -->
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-btn close-modal">Close</button>
                    <button type="button" id="editFromViewBtn" class="primary-btn" style="display: none;">
                        <i class="fas fa-edit"></i> Edit Item
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <h2 id="confirmationTitle">Confirm Action</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure?</p>
                <div class="confirmation-actions">
                    <button id="cancelActionBtn" class="secondary-btn">Cancel</button>
                    <button id="confirmActionBtn" class="danger-btn">
                        <span class="btn-text">Confirm</span>
                        <span class="btn-loading">
                            <i class="fas fa-spinner fa-spin"></i> Processing...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        // Complete Inventory Management JavaScript with soft delete functionality and unique name validation
        document.addEventListener('DOMContentLoaded', function() {
            
            // Global variables
            let currentEditingItemId = null;
            let currentActionItemId = null;
            let currentAction = null; // 'deactivate' or 'reactivate'
            
            // Print functionality
            document.getElementById('printInventoryBtn').addEventListener('click', function() {
                const currentStatus = '{{ status_filter }}';
                const activeFilter = document.querySelector('.filter-btn.active');
                const filterType = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
                const searchValue = document.getElementById('inventorySearch').value;
                
                let printUrl = '/print_inventory_report?status=' + encodeURIComponent(currentStatus);
                if (filterType !== 'all') {
                    printUrl += '&filter=' + encodeURIComponent(filterType);
                }
                if (searchValue) {
                    printUrl += '&search=' + encodeURIComponent(searchValue);
                }
                
                window.open(printUrl, '_blank');
            });

            // Search functionality
            const searchInput = document.getElementById('inventorySearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const tableRows = document.querySelectorAll('#inventoryTable tbody tr');
                    
                    tableRows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }

            // Filter functionality
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filterType = this.getAttribute('data-filter');
                    filterInventoryItems(filterType);
                });
            });

            function filterInventoryItems(filterType) {
                const tableRows = document.querySelectorAll('#inventoryTable tbody tr');
                
                tableRows.forEach(row => {
                    const itemType = row.getAttribute('data-type');
                    const isLowStock = row.classList.contains('low-stock') || row.querySelector('.status-badge.low') !== null;
                    const isExpired = row.classList.contains('expired') || row.querySelector('.status-badge.expired') !== null;
                    
                    let shouldShow = false;
                    
                    switch(filterType) {
                        case 'all':
                            shouldShow = true;
                            break;
                        case 'low_stock':
                            shouldShow = isLowStock;
                            break;
                        case 'expired':
                            shouldShow = isExpired;
                            break;
                        default:
                            shouldShow = itemType === filterType.replace(' ', '_');
                    }
                    
                    row.style.display = shouldShow ? '' : 'none';
                });
                
                // Update filter button counts
                updateFilterCounts();
            }

            function updateFilterCounts() {
                const tableRows = document.querySelectorAll('#inventoryTable tbody tr');
                let lowStockCount = 0;
                let expiredCount = 0;
                
                tableRows.forEach(row => {
                    const isLowStock = row.classList.contains('low-stock') || row.querySelector('.status-badge.low') !== null;
                    const isExpired = row.classList.contains('expired') || row.querySelector('.status-badge.expired') !== null;
                    
                    if (isLowStock) lowStockCount++;
                    if (isExpired) expiredCount++;
                });
                
                // Update filter button counts
                const lowStockFilterCount = document.getElementById('lowStockFilterCount');
                const expiredFilterCount = document.getElementById('expiredFilterCount');
                
                if (lowStockFilterCount) lowStockFilterCount.textContent = lowStockCount;
                if (expiredFilterCount) expiredFilterCount.textContent = expiredCount;
            }

            // Initialize filter counts on page load
            setTimeout(() => {
                updateFilterCounts();
            }, 100);

            // Unique name validation
            function checkItemNameUniqueness(itemName, excludeItemId = null) {
                const normalizedName = itemName.toLowerCase().trim();
                
                if (!normalizedName) {
                    return { isUnique: true, message: '' };
                }
                
                const tableRows = document.querySelectorAll('#inventoryTable tbody tr');
                
                for (let row of tableRows) {
                    const rowItemId = row.getAttribute('data-id');
                    const rowItemName = row.getAttribute('data-name');
                    
                    // Skip the current item being edited
                    if (excludeItemId && rowItemId === excludeItemId) {
                        continue;
                    }
                    
                    // Check if name already exists (case-insensitive)
                    if (rowItemName === normalizedName) {
                        return { 
                            isUnique: false, 
                            message: 'An item with this name already exists. Please choose a different name.' 
                        };
                    }
                }
                
                return { isUnique: true, message: '' };
            }

            function showNameValidation(isValid, message = '') {
                const nameGroup = document.getElementById('itemNameGroup');
                const nameInput = document.getElementById('itemName');
                const errorDiv = document.getElementById('itemNameError');
                const successDiv = document.getElementById('itemNameSuccess');
                
                // Reset states
                nameGroup.classList.remove('error', 'success');
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                
                if (nameInput.value.trim() === '') {
                    // Empty field - no validation display
                    return;
                }
                
                if (isValid) {
                    nameGroup.classList.add('success');
                    successDiv.style.display = 'flex';
                } else {
                    nameGroup.classList.add('error');
                    errorDiv.querySelector('span').textContent = message;
                    errorDiv.style.display = 'flex';
                }
            }

            // Real-time name validation
            document.getElementById('itemName').addEventListener('input', function() {
                const itemName = this.value.trim();
                
                if (itemName === '') {
                    showNameValidation(true);
                    return;
                }
                
                const validation = checkItemNameUniqueness(itemName, currentEditingItemId);
                showNameValidation(validation.isUnique, validation.message);
            });

            // Modal functionality
            const modals = document.querySelectorAll('.modal');
            const addItemBtn = document.getElementById('addItemBtn');
            const addFirstItemBtn = document.getElementById('addFirstItemBtn');
            
            // Open add item modal
            function openAddModal() {
                document.getElementById('modalTitle').textContent = 'Add New Item';
                document.getElementById('inventoryForm').reset();
                document.getElementById('itemId').value = '';
                currentEditingItemId = null;
                
                // Reset validation display
                showNameValidation(true);
                
                document.getElementById('itemModal').style.display = 'block';
                
                // Focus on item name field
                setTimeout(() => {
                    document.getElementById('itemName').focus();
                }, 100);
            }
            
            if (addItemBtn) {
                addItemBtn.addEventListener('click', openAddModal);
            }
            
            if (addFirstItemBtn) {
                addFirstItemBtn.addEventListener('click', openAddModal);
            }

            // Close modals
            document.querySelectorAll('.close-modal').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    modals.forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });

            // Close modal on outside click
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Cancel buttons
            document.getElementById('cancelBtn').addEventListener('click', function() {
                document.getElementById('itemModal').style.display = 'none';
            });

            document.getElementById('cancelActionBtn').addEventListener('click', function() {
                document.getElementById('confirmationModal').style.display = 'none';
                currentActionItemId = null;
                currentAction = null;
            });

            // Form submission with AJAX and name validation
            const inventoryForm = document.getElementById('inventoryForm');
            if (inventoryForm) {
                inventoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const itemName = document.getElementById('itemName').value.trim();
                    
                    // Validate item name uniqueness before submission
                    const validation = checkItemNameUniqueness(itemName, currentEditingItemId);
                    if (!validation.isUnique) {
                        showNameValidation(false, validation.message);
                        
                        // Scroll to the name field and focus
                        document.getElementById('itemName').focus();
                        document.getElementById('itemName').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        return;
                    }
                    
                    // Check if name is empty
                    if (!itemName) {
                        showNameValidation(false, 'Item name is required.');
                        document.getElementById('itemName').focus();
                        return;
                    }
                    
                    const saveBtn = document.getElementById('saveItemBtn');
                    const btnText = saveBtn.querySelector('.btn-text');
                    const btnLoading = saveBtn.querySelector('.btn-loading');
                    
                    // Show loading state
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'inline';
                    saveBtn.disabled = true;
                    
                    const formData = new FormData(inventoryForm);
                    const isEdit = currentEditingItemId !== null;
                    
                    const url = isEdit ? `/update_inventory/${currentEditingItemId}` : '/add_inventory';
                    
                    fetch(url, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('success', isEdit ? 'Item updated successfully!' : 'Item added successfully!');
                            document.getElementById('itemModal').style.display = 'none';
                            
                            if (isEdit) {
                                // Update existing row
                                updateInventoryRow(currentEditingItemId, data.item);
                            } else {
                                // Add new row or refresh if needed
                                addInventoryRow(data.item);
                            }
                            
                            // Update stats if provided
                            if (data.stats) {
                                updateInventoryStats(data.stats);
                            }
                        } else {
                            showAlert('error', data.error || 'An error occurred while saving the item.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('error', 'An error occurred while saving the item.');
                    })
                    .finally(() => {
                        // Hide loading state
                        btnText.style.display = 'inline';
                        btnLoading.style.display = 'none';
                        saveBtn.disabled = false;
                    });
                });
            }

            // Action buttons event delegation
            document.addEventListener('click', function(e) {
                // View button
                if (e.target.closest('.view-btn')) {
                    const itemId = e.target.closest('.view-btn').getAttribute('data-id');
                    viewItem(itemId);
                }
                
                // Edit button
                if (e.target.closest('.edit-btn')) {
                    const itemId = e.target.closest('.edit-btn').getAttribute('data-id');
                    editItem(itemId);
                }
                
                // Deactivate button
                if (e.target.closest('.deactivate-btn')) {
                    const itemId = e.target.closest('.deactivate-btn').getAttribute('data-id');
                    confirmAction(itemId, 'deactivate');
                }
                
                // Reactivate button
                if (e.target.closest('.reactivate-btn')) {
                    const itemId = e.target.closest('.reactivate-btn').getAttribute('data-id');
                    confirmAction(itemId, 'reactivate');
                }
            });

            // View item functionality
            function viewItem(itemId) {
                showLoading();
                
                fetch(`/inventory_item/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayItemDetails(data.item);
                        document.getElementById('viewItemModal').style.display = 'block';
                    } else {
                        showAlert('error', data.error || 'Failed to load item details.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Failed to load item details.');
                })
                .finally(() => {
                    hideLoading();
                });
            }

            // Edit item functionality
            function editItem(itemId) {
                showLoading();
                
                fetch(`/inventory_item/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateEditForm(data.item);
                        currentEditingItemId = itemId;
                        document.getElementById('modalTitle').textContent = 'Edit Item';
                        
                        // Reset validation display
                        showNameValidation(true);
                        
                        document.getElementById('itemModal').style.display = 'block';
                        
                        // Focus on item name field
                        setTimeout(() => {
                            document.getElementById('itemName').focus();
                        }, 100);
                    } else {
                        showAlert('error', data.error || 'Failed to load item details.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Failed to load item details.');
                })
                .finally(() => {
                    hideLoading();
                });
            }

            // Action confirmation (deactivate/reactivate)
            function confirmAction(itemId, action) {
                currentActionItemId = itemId;
                currentAction = action;
                
                const title = action === 'deactivate' ? 'Confirm Deactivation' : 'Confirm Reactivation';
                const message = action === 'deactivate' 
                    ? 'Are you sure you want to deactivate this item? You can reactivate it later.'
                    : 'Are you sure you want to reactivate this item?';
                const btnClass = action === 'deactivate' ? 'danger-btn' : 'primary-btn';
                const btnText = action === 'deactivate' ? 'Deactivate' : 'Reactivate';
                
                document.getElementById('confirmationTitle').textContent = title;
                document.getElementById('confirmationMessage').textContent = message;
                
                const confirmBtn = document.getElementById('confirmActionBtn');
                confirmBtn.className = btnClass;
                confirmBtn.querySelector('.btn-text').textContent = btnText;
                
                document.getElementById('confirmationModal').style.display = 'block';
            }

            // Confirm action button
            document.getElementById('confirmActionBtn').addEventListener('click', function() {
                if (!currentActionItemId || !currentAction) return;
                
                const actionBtn = document.getElementById('confirmActionBtn');
                const btnText = actionBtn.querySelector('.btn-text');
                const btnLoading = actionBtn.querySelector('.btn-loading');
                
                // Show loading state
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                actionBtn.disabled = true;
                
                const url = currentAction === 'deactivate' 
                    ? `/deactivate_inventory/${currentActionItemId}` 
                    : `/reactivate_inventory/${currentActionItemId}`;
                
                fetch(url, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const successMessage = currentAction === 'deactivate' 
                            ? 'Item deactivated successfully!' 
                            : 'Item reactivated successfully!';
                        showAlert('success', successMessage);
                        document.getElementById('confirmationModal').style.display = 'none';
                        
                        // Update the row or remove if needed
                        if (currentAction === 'deactivate') {
                            updateRowToInactive(currentActionItemId);
                        } else {
                            updateRowToActive(currentActionItemId);
                        }
                        
                        // Update stats if provided
                        if (data.stats) {
                            updateInventoryStats(data.stats);
                        }
                        
                        // Check if we need to reload for status filter
                        const currentStatus = '{{ status_filter }}';
                        if ((currentStatus === 'active' && currentAction === 'deactivate') ||
                            (currentStatus === 'inactive' && currentAction === 'reactivate')) {
                            // Remove the row since it no longer matches the filter
                            removeInventoryRow(currentActionItemId);
                        }
                        
                        currentActionItemId = null;
                        currentAction = null;
                    } else {
                        showAlert('error', data.error || 'Failed to perform action.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Failed to perform action.');
                })
                .finally(() => {
                    // Hide loading state
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    actionBtn.disabled = false;
                });
            });

            // Edit from view modal
            document.getElementById('editFromViewBtn').addEventListener('click', function() {
                document.getElementById('viewItemModal').style.display = 'none';
                if (currentEditingItemId) {
                    editItem(currentEditingItemId);
                }
            });

            // Helper functions
            function displayItemDetails(item) {
                const detailsDiv = document.getElementById('itemDetails');
                const expiryDisplay = item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'No Expiry';
                
                // Use the status provided by the backend
                const statusText = item.is_active ? (item.status || 'OK') : 'Inactive';
                const statusClass = item.is_active ? (item.status ? item.status.toLowerCase().replace(' ', '-') : 'ok') : 'inactive';
                
                detailsDiv.innerHTML = `
                    <div class="item-details">
                        <div class="detail-row">
                            <strong>Item ID:</strong> ${item.id}
                        </div>
                        <div class="detail-row">
                            <strong>Name:</strong> ${item.name}
                        </div>
                        <div class="detail-row">
                            <strong>Category:</strong> ${item.type}
                        </div>
                        <div class="detail-row">
                            <strong>Quantity:</strong> ${item.quantity}
                        </div>
                        <div class="detail-row">
                            <strong>Expiry Date:</strong> ${expiryDisplay}
                        </div>
                        <div class="detail-row">
                            <strong>Minimum Quantity:</strong> ${item.min_quantity || 'Not set'}
                        </div>
                        <div class="detail-row">
                            <strong>Status:</strong> <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Remarks:</strong> ${item.remarks || 'None'}
                        </div>
                    </div>
                `;
                
                // Set the current editing ID for the edit button
                currentEditingItemId = item.raw_id;
                
                // Show/hide edit button based on active status
                const editBtn = document.getElementById('editFromViewBtn');
                editBtn.style.display = item.is_active ? 'inline-block' : 'none';
            }

            function populateEditForm(item) {
                document.getElementById('itemId').value = item.raw_id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemType').value = item.type;
                document.getElementById('itemQuantity').value = item.quantity;
                document.getElementById('itemExpiry').value = item.expiry_date || '';
                document.getElementById('minQuantity').value = item.min_quantity;
                document.getElementById('itemRemarks').value = item.remarks || '';
            }

            function addInventoryRow(item) {
                const tbody = document.querySelector('#inventoryTable tbody');
                if (!tbody) {
                    // If no table exists, reload the page to show the table
                    location.reload();
                    return;
                }
                
                const row = createInventoryRow(item);
                tbody.insertBefore(row, tbody.firstChild);
            }

            function updateInventoryRow(itemId, item) {
                const row = document.querySelector(`tr[data-id="${itemId}"]`);
                if (row) {
                    const newRow = createInventoryRow(item);
                    row.parentNode.replaceChild(newRow, row);
                }
            }

            function removeInventoryRow(itemId) {
                const row = document.querySelector(`tr[data-id="${itemId}"]`);
                if (row) {
                    row.remove();
                    
                    // Check if table is now empty
                    const tbody = document.querySelector('#inventoryTable tbody');
                    if (tbody && tbody.children.length === 0) {
                        // Show empty state
                        const tableContainer = document.querySelector('.inventory-table-container');
                        const currentStatus = '{{ status_filter }}';
                        
                        let emptyMessage = '';
                        if (currentStatus === 'inactive') {
                            emptyMessage = `
                                <div class="empty-state">
                                    <i class="fas fa-box-open"></i>
                                    <h3>No inactive inventory items</h3>
                                    <p>All your inventory items are currently active.</p>
                                </div>
                            `;
                        } else {
                            emptyMessage = `
                                <div class="empty-state">
                                    <i class="fas fa-box-open"></i>
                                    <h3>No active inventory items found</h3>
                                    <p>Start by adding your first inventory item.</p>
                                    <button id="addFirstItemBtn" class="primary-btn">
                                        <i class="fas fa-plus"></i> Add First Item
                                    </button>
                                </div>
                            `;
                        }
                        
                        tableContainer.innerHTML = emptyMessage;
                        
                        // Re-attach event listener if needed
                        const newAddBtn = document.getElementById('addFirstItemBtn');
                        if (newAddBtn) {
                            newAddBtn.addEventListener('click', openAddModal);
                        }
                    }
                }
            }

            function updateRowToInactive(itemId) {
                const row = document.querySelector(`tr[data-id="${itemId}"]`);
                if (row) {
                    row.classList.add('inactive');
                    
                    // Update status badge
                    const statusBadge = row.querySelector('.status-badge');
                    statusBadge.className = 'status-badge inactive';
                    statusBadge.textContent = 'Inactive';
                    
                    // Update item name to show inactive
                    const nameCell = row.querySelector('td:nth-child(2)');
                    if (!nameCell.innerHTML.includes('(Inactive)')) {
                        nameCell.innerHTML += ' <small class="text-muted">(Inactive)</small>';
                    }
                    
                    // Update action buttons
                    const actionsDiv = row.querySelector('.actions');
                    actionsDiv.innerHTML = `
                        <button class="view-btn" title="View Details" data-id="${itemId}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="reactivate-btn" title="Reactivate Item" data-id="${itemId}">
                            <i class="fas fa-check"></i>
                        </button>
                    `;
                }
            }

            function updateRowToActive(itemId) {
                const row = document.querySelector(`tr[data-id="${itemId}"]`);
                if (row) {
                    row.classList.remove('inactive');
                    
                    // This would need the full item data to properly update
                    // For now, just refresh the page or fetch the item details
                    location.reload();
                }
            }

            function createInventoryRow(item) {
                const row = document.createElement('tr');
                row.setAttribute('data-id', item.raw_id);
                row.setAttribute('data-type', item.type.toLowerCase().replace(' ', '_'));
                row.setAttribute('data-name', item.name.toLowerCase());
                
                // Apply CSS classes based on backend status
                let cssClasses = [];
                if (!item.is_active) cssClasses.push('inactive');
                if (item.status === 'Low Stock' || item.status === 'Low') cssClasses.push('low-stock');
                if (item.status && item.status.toLowerCase().includes('expired')) cssClasses.push('expired');
                
                if (cssClasses.length > 0) {
                    row.className = cssClasses.join(' ');
                }
                
                const expiryDisplay = item.expiry !== 'N/A' ? item.expiry : 'No Expiry';
                const itemName = item.name + (!item.is_active ? ' <small class="text-muted">(Inactive)</small>' : '');
                
                // Use the status provided by backend
                const statusBadge = !item.is_active 
                    ? '<span class="status-badge inactive">Inactive</span>'
                    : `<span class="status-badge ${item.status ? item.status.toLowerCase().replace(' ', '-') : 'ok'}">${item.status || 'OK'}</span>`;
                
                const actionButtons = !item.is_active
                    ? `
                        <button class="view-btn" title="View Details" data-id="${item.raw_id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="reactivate-btn" title="Reactivate Item" data-id="${item.raw_id}">
                            <i class="fas fa-check"></i>
                        </button>
                    `
                    : `
                        <button class="view-btn" title="View Details" data-id="${item.raw_id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="edit-btn" title="Edit Item" data-id="${item.raw_id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="deactivate-btn" title="Deactivate Item" data-id="${item.raw_id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${itemName}</td>
                    <td>${item.type}</td>
                    <td>${item.quantity}</td>
                    <td>${expiryDisplay}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="actions">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                return row;
            }

            function updateInventoryStats(stats) {
                const totalElement = document.getElementById('totalItemsCount');
                const lowStockElement = document.getElementById('lowStockCount');
                const expiredElement = document.getElementById('expiredCount');
                
                if (totalElement) totalElement.textContent = stats.total_items;
                if (lowStockElement) lowStockElement.textContent = stats.low_stock;
                if (expiredElement) expiredElement.textContent = stats.expired;
            }

            function showAlert(type, message) {
                // Remove existing alerts
                const existingAlerts = document.querySelectorAll('.alert');
                existingAlerts.forEach(alert => alert.remove());
                
                // Create new alert
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                `;
                
                // Insert after page header
                const pageHeader = document.querySelector('.page-header');
                pageHeader.insertAdjacentElement('afterend', alert);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            }

            function showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            function hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
    </script>

</body>
</html>