<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Chart - {{ patient.patname }} - Pullan Dental Clinic</title>
    <link rel="stylesheet" href="../static/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        /* Dental Chart Specific Styles */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .main-chart-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        /* Patient Info Card */
        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            font-weight: 500;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .info-value {
            font-size: 14px;
            color: var(--text-color);
        }
        
        /* Dental Chart Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        /* UPDATED: Required field styling */
        .form-group.required .form-label::after {
            content: ' *';
            color: #dc3545;
            font-weight: bold;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }
        
        /* UPDATED: Error state for required fields */
        .form-input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Questionnaire */
        .questionnaire-section {
            margin-top: 20px;
        }
        
        .question-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }
        
        /* UPDATED: Required question styling */
        .question-group.required {
            border-left: 4px solid #dc3545;
        }
        
        .question-group.error {
            background-color: rgba(220, 53, 69, 0.05);
            border-left: 4px solid #dc3545;
        }
        
        .question-text {
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        /* UPDATED: Required question indicator */
        .question-text.required::after {
            content: ' *';
            color: #dc3545;
            font-weight: bold;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-item input[type="radio"] {
            accent-color: var(--primary-color);
        }
        
        .explanation-input {
            margin-top: 10px;
            display: none;
        }
        
        .explanation-input.show {
            display: block;
        }
        
        /* UPDATED: Error message styling */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .error-message i {
            margin-right: 8px;
        }
        
        /* Success message styling */
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
        
        .success-message i {
            margin-right: 8px;
        }
        
        /* Teeth Chart */
        .teeth-chart-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
        
        .teeth-chart-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        
        .quadrants-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .quadrant {
            background-color: var(--white);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
        }
        
        .quadrant-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .teeth-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            justify-items: center;
        }
        
        .tooth {
            width: 45px;
            height: 45px;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 3px;
            position: relative;
        }
        
        .tooth:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .tooth.healthy { background-color: #ffffff; }
        .tooth.caries { background-color: #ffcccc; }
        .tooth.filled { background-color: #cccccc; }
        .tooth.crown { background-color: #ffffcc; }
        .tooth.extracted { 
            background-color: #333333; 
            color: white;
        }
        .tooth.root-canal { background-color: #ffccff; }
        .tooth.implant { background-color: #ccffcc; }
        
        /* Teeth Legend */
        .teeth-legend {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background-color: var(--white);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .legend-color.healthy { background-color: #ffffff; }
        .legend-color.caries { background-color: #ffcccc; }
        .legend-color.filled { background-color: #cccccc; }
        .legend-color.crown { background-color: #ffffcc; }
        .legend-color.extracted { background-color: #333333; }
        .legend-color.root-canal { background-color: #ffccff; }
        .legend-color.implant { background-color: #ccffcc; }
        
        /* Condition Selector Modal */
        .condition-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .condition-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 400px;
            width: 90%;
        }
        
        .condition-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .condition-option {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .condition-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
        }
        
        .condition-option.healthy { background-color: #ffffff; }
        .condition-option.caries { background-color: #ffcccc; }
        .condition-option.filled { background-color: #cccccc; }
        .condition-option.crown { background-color: #ffffcc; }
        .condition-option.extracted { background-color: #333333; color: white; }
        .condition-option.root-canal { background-color: #ffccff; }
        .condition-option.implant { background-color: #ccffcc; }
        
        /* Sidebar */
        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #3367d6;
            color: white;
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2d8f47;
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .teeth-legend {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .quadrants-container {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand">
                <h2>Pullan Dental</h2>
                <p>Clinic Management System</p>
            </div>
            <ul class="nav-menu">
                <!-- Admin Only - Backup & Restore -->
                {% if session.get('access_level') == 'admin' %}
                <li><a href="{{ url_for('backup_restore') }}"><i class="fas fa-database"></i> Backup & Restore</a></li>
                {% endif %}
                <li class="active"><a href="{{ url_for('dashboard') }}"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="{{ url_for('patients') }}"><i class="fas fa-user-injured"></i> Patients</a></li>
                <li><a href="{{ url_for('appointments') }}"><i class="fas fa-calendar-alt"></i> Appointments</a></li>
                <li><a href="{{ url_for('staff') }}"><i class="fas fa-user-md"></i> Staff</a></li>
                <li><a href="{{ url_for('inventory') }}"><i class="fas fa-box"></i> Inventory</a></li>
                <li><a href="{{ url_for('dental_charts') }}"><i class="fas fa-teeth"></i> Dental Charts</a></li>
                <!-- Admin Only - User Logs -->
                {% if session.get('access_level') == 'admin' %}
                <li><a href="{{ url_for('user_logs') }}"><i class="fas fa-history"></i> User Logs</a></li>
                {% endif %}
                <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
            <div class="logout">
                <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-bar">
                    <input type="text" placeholder="Search...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="user-info">
                    <div class="user">
                        <span>{{ session.get('real_name', session.get('username', 'User')) }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Dental Chart Overview -->
            <div class="dashboard-overview">
                <h1>
                    <i class="fas fa-tooth"></i>
                    Dental Chart - {{ patient.patname }}
                </h1>
                <p class="date">{{ current_date }}</p>
                
                <!-- Main Chart Container -->
                <div class="chart-container">
                    <!-- Main Chart Area -->
                    <div class="main-chart-area">
                        <!-- Patient Information Card -->
                        <div class="chart-card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-user"></i> Patient Information</h3>
                            </div>
                            <div class="patient-info-grid">
                                <div class="info-item">
                                    <span class="info-label">Patient ID</span>
                                    <span class="info-value">PAT-{{ "%03d"|format(patient.patId) }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Full Name</span>
                                    <span class="info-value">{{ patient.patname }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Contact</span>
                                    <span class="info-value">{{ patient.patcontact or "N/A" }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email</span>
                                    <span class="info-value">{{ patient.patemail or "N/A" }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Age / Gender</span>
                                    <span class="info-value">{{ patient.patage or "N/A" }} / {{ patient.patgender or "N/A" }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Date of Birth</span>
                                    <span class="info-value">{{ patient.patdob.strftime('%B %d, %Y') if patient.patdob else "N/A" }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dental Chart Information -->
                        <div class="chart-card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-file-medical"></i> Dental Chart Information</h3>
                            </div>
                            
                            <!-- UPDATED: Error and Success Message Areas -->
                            <div id="errorMessage" class="error-message">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="errorText"></span>
                            </div>
                            
                            <div id="successMessage" class="success-message">
                                <i class="fas fa-check-circle"></i>
                                <span id="successText"></span>
                            </div>
                            
                            <form id="dentalChartForm">
                                <input type="hidden" id="patientId" value="{{ patient.patId }}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Referring Doctor</label>
                                        <input type="text" class="form-input" id="doctor" value="{{ dental_chart.dcdoctor if dental_chart else '' }}" placeholder="Enter doctor name">
                                    </div>
                                    <!-- UPDATED: Dentist field is now required -->
                                    <div class="form-group required">
                                        <label class="form-label">Dentist</label>
                                        <input type="text" class="form-input" id="dentist" value="{{ dental_chart.dcdentist if dental_chart else '' }}" placeholder="Enter dentist name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Patient Contact</label>
                                        <input type="text" class="form-input" id="patient_contact" value="{{ dental_chart.dcpcontact if dental_chart else patient.patcontact }}" placeholder="Patient contact">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dentist Contact</label>
                                        <input type="text" class="form-input" id="dentist_contact" value="{{ dental_chart.dcdcontact if dental_chart else '' }}" placeholder="Dentist contact">
                                    </div>
                                </div>
                                
                                <!-- Health Questionnaire - UPDATED: All questions are required -->
                                <div class="questionnaire-section">
                                    <h4 style="margin-bottom: 20px; color: var(--primary-color);">
                                        <i class="fas fa-clipboard-list"></i> Health Questionnaire
                                        <small style="color: #dc3545; font-size: 14px; font-weight: normal;">(All questions are required)</small>
                                    </h4>
                                    
                                    <!-- Question 1 - REQUIRED -->
                                    <div class="question-group required" id="q1_group">
                                        <div class="question-text required">1. Are you currently taking any medications?</div>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" name="q1" value="Yes" {{ 'checked' if dental_chart and dental_chart.dcq1 == 'Yes' else '' }} required>
                                                <label>Yes</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q1" value="No" {{ 'checked' if dental_chart and dental_chart.dcq1 == 'No' else '' }} required>
                                                <label>No</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Question 2 - REQUIRED -->
                                    <div class="question-group required" id="q2_group">
                                        <div class="question-text required">2. Do you have any allergies to medications?</div>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" name="q2" value="Yes" {{ 'checked' if dental_chart and dental_chart.dcq2 == 'Yes' else '' }} onchange="toggleExplanation('q2')" required>
                                                <label>Yes</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q2" value="No" {{ 'checked' if dental_chart and dental_chart.dcq2 == 'No' else '' }} onchange="toggleExplanation('q2')" required>
                                                <label>No</label>
                                            </div>
                                        </div>
                                        <div class="explanation-input {{ 'show' if dental_chart and dental_chart.dcq2 == 'Yes' else '' }}" id="q2_explanation">
                                            <input type="text" class="form-input" name="qe2" placeholder="Please specify allergies" value="{{ dental_chart.dcqe2 if dental_chart else '' }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Question 3 - REQUIRED -->
                                    <div class="question-group required" id="q3_group">
                                        <div class="question-text required">3. Have you had any serious illnesses or surgeries?</div>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" name="q3" value="Yes" {{ 'checked' if dental_chart and dental_chart.dcq3 == 'Yes' else '' }} onchange="toggleExplanation('q3')" required>
                                                <label>Yes</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q3" value="No" {{ 'checked' if dental_chart and dental_chart.dcq3 == 'No' else '' }} onchange="toggleExplanation('q3')" required>
                                                <label>No</label>
                                            </div>
                                        </div>
                                        <div class="explanation-input {{ 'show' if dental_chart and dental_chart.dcq3 == 'Yes' else '' }}" id="q3_explanation">
                                            <input type="text" class="form-input" name="qe3" placeholder="Please specify" value="{{ dental_chart.dcqe3 if dental_chart else '' }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Question 4 - REQUIRED -->
                                    <div class="question-group required" id="q4_group">
                                        <div class="question-text required">4. Do you have any heart problems?</div>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" name="q4" value="Yes" {{ 'checked' if dental_chart and dental_chart.dcq4 == 'Yes' else '' }} onchange="toggleExplanation('q4')" required>
                                                <label>Yes</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q4" value="No" {{ 'checked' if dental_chart and dental_chart.dcq4 == 'No' else '' }} onchange="toggleExplanation('q4')" required>
                                                <label>No</label>
                                            </div>
                                        </div>
                                        <div class="explanation-input {{ 'show' if dental_chart and dental_chart.dcq4 == 'Yes' else '' }}" id="q4_explanation">
                                            <input type="text" class="form-input" name="qe4" placeholder="Please specify" value="{{ dental_chart.dcqe4 if dental_chart else '' }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Question 5 - REQUIRED -->
                                    <div class="question-group required" id="q5_group">
                                        <div class="question-text required">5. Are you pregnant or nursing?</div>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" name="q5" value="Yes" {{ 'checked' if dental_chart and dental_chart.dcq5 == 'Yes' else '' }} onchange="toggleExplanation('q5')" required>
                                                <label>Yes</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q5" value="No" {{ 'checked' if dental_chart and dental_chart.dcq5 == 'No' else '' }} onchange="toggleExplanation('q5')" required>
                                                <label>No</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q5" value="N/A" {{ 'checked' if dental_chart and dental_chart.dcq5 == 'N/A' else '' }} onchange="toggleExplanation('q5')" required>
                                                <label>N/A</label>
                                            </div>
                                        </div>
                                        <div class="explanation-input {{ 'show' if dental_chart and dental_chart.dcq5 == 'Yes' else '' }}" id="q5_explanation">
                                            <input type="text" class="form-input" name="qe5" placeholder="Please specify" value="{{ dental_chart.dcqe5 if dental_chart else '' }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Question 6 - REQUIRED -->
                                    <div class="question-group required" id="q6_group">
                                        <div class="question-text required">6. Do you smoke or use tobacco products?</div>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" name="q6" value="Yes" {{ 'checked' if dental_chart and dental_chart.dcq6 == 'Yes' else '' }} required>
                                                <label>Yes</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" name="q6" value="No" {{ 'checked' if dental_chart and dental_chart.dcq6 == 'No' else '' }} required>
                                                <label>No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Interactive Teeth Chart -->
                        <div class="chart-card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-teeth"></i> Interactive Teeth Chart</h3>
                            </div>
                            
                            <div class="teeth-chart-container">
                                <div class="teeth-chart-title">Dental Chart - Click on teeth to modify conditions</div>
                                
                                <div class="quadrants-container">
                                    <!-- Upper Right (Quadrant 1) -->
                                    <div class="quadrant">
                                        <div class="quadrant-title">Upper Right (Quadrant 1)</div>
                                        <div class="teeth-grid">
                                            {% for tooth in teeth_data %}
                                                {% if tooth.quadrant == 1 %}
                                                <div class="tooth {{ tooth.condition }}" data-tooth="{{ tooth.number }}" onclick="openConditionModal({{ tooth.number }})">
                                                    {{ tooth.number }}
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Upper Left (Quadrant 2) -->
                                    <div class="quadrant">
                                        <div class="quadrant-title">Upper Left (Quadrant 2)</div>
                                        <div class="teeth-grid">
                                            {% for tooth in teeth_data %}
                                                {% if tooth.quadrant == 2 %}
                                                <div class="tooth {{ tooth.condition }}" data-tooth="{{ tooth.number }}" onclick="openConditionModal({{ tooth.number }})">
                                                    {{ tooth.number }}
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Lower Right (Quadrant 4) -->
                                    <div class="quadrant">
                                        <div class="quadrant-title">Lower Right (Quadrant 4)</div>
                                        <div class="teeth-grid">
                                            {% for tooth in teeth_data %}
                                                {% if tooth.quadrant == 4 %}
                                                <div class="tooth {{ tooth.condition }}" data-tooth="{{ tooth.number }}" onclick="openConditionModal({{ tooth.number }})">
                                                    {{ tooth.number }}
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Lower Left (Quadrant 3) -->
                                    <div class="quadrant">
                                        <div class="quadrant-title">Lower Left (Quadrant 3)</div>
                                        <div class="teeth-grid">
                                            {% for tooth in teeth_data %}
                                                {% if tooth.quadrant == 3 %}
                                                <div class="tooth {{ tooth.condition }}" data-tooth="{{ tooth.number }}" onclick="openConditionModal({{ tooth.number }})">
                                                    {{ tooth.number }}
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Legend -->
                                <div class="teeth-legend">
                                    <div class="legend-item">
                                        <div class="legend-color healthy"></div>
                                        <span>Healthy</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color caries"></div>
                                        <span>Caries</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color filled"></div>
                                        <span>Filled</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color crown"></div>
                                        <span>Crown</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color root-canal"></div>
                                        <span>Root Canal</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color extracted"></div>
                                        <span>Extracted</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color implant"></div>
                                        <span>Implant</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="saveButton" onclick="saveDentalChart()">
                                <i class="fas fa-save"></i> Save Complete Chart
                            </button>
                            <a href="/print_dental_chart/{{ patient.patId }}" class="btn btn-success" target="_blank">
                                <i class="fas fa-print"></i> Print Chart
                            </a>
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
    <div class="sidebar-section">
        <!-- Sidebar content removed -->
    </div>
    
    <!-- Tooth Condition Modal -->
    <div class="condition-modal" id="conditionModal">
        <div class="condition-modal-content">
            <h3 style="margin-bottom: 20px; text-align: center;">
                Select Tooth Condition
                <span id="selectedToothNumber" style="color: var(--primary-color);"></span>
            </h3>
            
            <div class="condition-options">
                <div class="condition-option healthy" onclick="setToothCondition('healthy')">
                    <i class="fas fa-tooth"></i><br>Healthy
                </div>
                <div class="condition-option caries" onclick="setToothCondition('caries')">
                    <i class="fas fa-exclamation-triangle"></i><br>Caries
                </div>
                <div class="condition-option filled" onclick="setToothCondition('filled')">
                    <i class="fas fa-circle"></i><br>Filled
                </div>
                <div class="condition-option crown" onclick="setToothCondition('crown')">
                    <i class="fas fa-crown"></i><br>Crown
                </div>
                <div class="condition-option root-canal" onclick="setToothCondition('root-canal')">
                    <i class="fas fa-medical"></i><br>Root Canal
                </div>
                <div class="condition-option extracted" onclick="setToothCondition('extracted')">
                    <i class="fas fa-times"></i><br>Extracted
                </div>
                <div class="condition-option implant" onclick="setToothCondition('implant')">
                    <i class="fas fa-plus"></i><br>Implant
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeConditionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentToothNumber = null;
        
        // Toggle explanation inputs based on radio selection
        function toggleExplanation(questionNumber) {
            const radioButtons = document.querySelectorAll(`input[name="${questionNumber}"]`);
            const explanationDiv = document.getElementById(`${questionNumber}_explanation`);
            
            let showExplanation = false;
            radioButtons.forEach(radio => {
                if (radio.checked && radio.value === 'Yes') {
                    showExplanation = true;
                }
            });
            
            if (showExplanation) {
                explanationDiv.classList.add('show');
            } else {
                explanationDiv.classList.remove('show');
            }
            
            // UPDATED: Clear validation styling when user makes a selection
            clearValidationError(questionNumber + '_group');
        }
        
        // UPDATED: Validation helper functions
        function showError(message, missingFields = []) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.add('show');
            
            // Highlight missing fields
            missingFields.forEach(field => {
                if (field.startsWith('Question')) {
                    const questionNum = field.split(' ')[1];
                    const groupElement = document.getElementById(`q${questionNum}_group`);
                    if (groupElement) {
                        groupElement.classList.add('error');
                    }
                } else if (field === 'Dentist Name') {
                    const dentistInput = document.getElementById('dentist');
                    if (dentistInput) {
                        dentistInput.classList.add('error');
                    }
                }
            });
            
            // Scroll to error message
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideError();
            }, 10000);
        }
        
        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('show');
            
            // Clear all error styling
            document.querySelectorAll('.error').forEach(el => {
                el.classList.remove('error');
            });
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successDiv.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 5000);
        }
        
        function clearValidationError(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('error');
            }
        }
        
        // UPDATED: Enhanced form validation
        function validateForm() {
            const missingFields = [];
            
            // Clear previous error styling
            hideError();
            
            // Check dentist field
            const dentistValue = document.getElementById('dentist').value.trim();
            if (!dentistValue) {
                missingFields.push('Dentist Name');
            }
            
            // Check all required questions (q1-q6)
            for (let i = 1; i <= 6; i++) {
                const radioButtons = document.querySelectorAll(`input[name="q${i}"]`);
                let isAnswered = false;
                
                radioButtons.forEach(radio => {
                    if (radio.checked) {
                        isAnswered = true;
                    }
                });
                
                if (!isAnswered) {
                    missingFields.push(`Question ${i}`);
                }
            }
            
            return missingFields;
        }
        
        // Open tooth condition modal
        function openConditionModal(toothNumber) {
            currentToothNumber = toothNumber;
            document.getElementById('selectedToothNumber').textContent = `#${toothNumber}`;
            document.getElementById('conditionModal').style.display = 'block';
        }
        
        // Close tooth condition modal
        function closeConditionModal() {
            document.getElementById('conditionModal').style.display = 'none';
            currentToothNumber = null;
        }
        
        // Set tooth condition
        function setToothCondition(condition) {
            if (currentToothNumber) {
                const toothElement = document.querySelector(`[data-tooth="${currentToothNumber}"]`);
                
                // Remove all condition classes
                toothElement.className = 'tooth ' + condition;
                
                // Send AJAX request to update in database
                const formData = new FormData();
                formData.append('patient_id', document.getElementById('patientId').value);
                formData.append('tooth_number', currentToothNumber);
                formData.append('condition', condition);
                
                fetch('/update_tooth_condition', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Tooth condition updated successfully');
                    } else {
                        alert('Error updating tooth condition: ' + data.error);
                        location.reload(); // Reload to restore original state
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating tooth condition');
                });
            }
            
            closeConditionModal();
        }
        
        // UPDATED: Enhanced save function with validation
        function saveDentalChart() {
            const saveButton = document.getElementById('saveButton');
            
            // Validate form first
            const missingFields = validateForm();
            
            if (missingFields.length > 0) {
                showError(`Please complete the following required fields: ${missingFields.join(', ')}`, missingFields);
                return;
            }
            
            // Disable button and show loading state
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const formData = new FormData();
            formData.append('patient_id', document.getElementById('patientId').value);
            formData.append('doctor', document.getElementById('doctor').value);
            formData.append('dentist', document.getElementById('dentist').value);
            formData.append('dentist_contact', document.getElementById('dentist_contact').value);
            
            // Add questionnaire responses
            const radioInputs = document.querySelectorAll('input[type="radio"]:checked');
            radioInputs.forEach(input => {
                formData.append(input.name, input.value);
            });
            
            // Add explanation fields
            const explanationInputs = document.querySelectorAll('input[name^="qe"]');
            explanationInputs.forEach(input => {
                formData.append(input.name, input.value);
            });
            
            fetch('/update_dental_chart', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Complete Chart';
                
                if (data.success) {
                    showSuccess(data.message || 'Dental chart saved successfully! Chart is now complete.');
                    
                    // Update page URL to reflect completion
                    const currentUrl = new URL(window.location);
                    currentUrl.searchParams.set('completed', 'true');
                    window.history.replaceState({}, '', currentUrl);
                    
                } else {
                    if (data.missing_fields) {
                        showError(data.error, data.missing_fields);
                    } else {
                        showError('Error saving dental chart: ' + data.error);
                    }
                }
            })
            .catch(error => {
                // Re-enable button
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Complete Chart';
                
                console.error('Error:', error);
                showError('Error saving dental chart. Please try again.');
            });
        }
        
        // Clear validation errors when user starts typing in dentist field
        document.getElementById('dentist').addEventListener('input', function() {
            clearValidationError('dentist');
            this.classList.remove('error');
        });
        
        // Clear validation errors when user selects radio buttons
        document.addEventListener('change', function(event) {
            if (event.target.type === 'radio') {
                const questionName = event.target.name;
                clearValidationError(questionName + '_group');
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('conditionModal');
            if (event.target === modal) {
                closeConditionModal();
            }
        }
        
        // Set current date as default
        document.addEventListener('DOMContentLoaded', function() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            const now = new Date();
            const day = days[now.getDay()];
            const date = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            const dateElement = document.querySelector('.date');
            if (dateElement) {
                dateElement.textContent = `${day}, ${month} ${date}, ${year}`;
            }
            
            // Check if chart was just completed and show success message
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('completed') === 'true') {
                showSuccess('Chart completed successfully! All required information has been saved.');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
        
        console.log('Dental Chart loaded with validation - All fields are required for completion');
    </script>
</body>
</html>